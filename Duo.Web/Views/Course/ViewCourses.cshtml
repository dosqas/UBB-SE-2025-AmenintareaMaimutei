@model List<DuoClassLibrary.Models.Course>
@using System.Text.Json
@{
    ViewData["Title"] = "Courses";
    var coursesJson = JsonSerializer.Serialize(Model.Select(c => new
    {
        id = c.CourseId,
        title = c.Title,
        description = c.Description,
        type = c.IsPremium ? "Premium" : "Free",
        image = c.ImageUrl,
        duration = TimeSpan.FromSeconds(c.TimeToComplete).ToString(@"h\h\ m\m"),
        difficulty = c.Difficulty,
        tags = c.Tags.Select(t => new { id = t.TagId, name = t.Name }).ToList()
    }));
}

<div class="container">
    <h1 class="mb-4">Courses</h1>

    <div class="mb-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search courses..." onkeyup="handleSearch()">
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <select id="filterSelect" class="form-select" onchange="handleFilterChange()">
                <option value="All">All Types</option>
                <option value="Free">Free</option>
                <option value="Premium">Premium</option>
            </select>
        </div>
        <div class="col-md-6">
            <select id="tagSelect" class="form-select" onchange="handleFilterChange()">
                <option value="All">Clear Tags</option>
            </select>
        </div>
    </div>

    <div class="row" id="courseContainer"></div>

    <nav>
        <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
    </nav>
</div>

@section Scripts {
    <script>
        let allCourses = @Html.Raw(coursesJson);
        let filteredCourses = [...allCourses];
        const coursesPerPage = 6;
        let currentPage = 1;
        let allTags = [];

        // Initialize tags dropdown
        async function initializeTags() {
            const tagSelect = document.getElementById("tagSelect");
            try {
                const response = await fetch('/Course/GetTags');
                if (!response.ok) {
                    throw new Error('Failed to fetch tags');
                }
                allTags = await response.json();
                
                // Clear existing options except the first one
                while (tagSelect.options.length > 1) {
                    tagSelect.remove(1);
                }

                // Add new options
                allTags.forEach(tag => {
                    const option = document.createElement("option");
                    option.value = tag.tagId;
                    option.textContent = tag.name;
                    tagSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching tags:', error);
            }
        }

        function renderCourses() {
            const courseContainer = document.getElementById("courseContainer");
            courseContainer.innerHTML = "";
            const startIndex = (currentPage - 1) * coursesPerPage;
            const endIndex = startIndex + coursesPerPage;
            const paginatedCourses = filteredCourses.slice(startIndex, endIndex);

            if (paginatedCourses.length === 0) {
                courseContainer.innerHTML = "<p>No courses found.</p>";
                return;
            }

            paginatedCourses.forEach(course => {
                const courseCard = document.createElement("div");
                courseCard.className = "col-md-4 mb-4";
                courseCard.innerHTML = `
                    <div class="card h-100">
                        <img src="${course.image}" class="card-img-top" alt="${course.title}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${course.title}</h5>
                            <p class="card-text">${course.description}</p>
                            <div class="mt-auto">
                                <span class="badge ${course.type === "Premium" ? "bg-warning" : "bg-success"}">${course.type}</span>
                                <span class="badge bg-info text-dark">${course.difficulty}</span>
                                <span class="badge bg-secondary">${course.duration}</span>
                                ${course.tags.map(tag => `<span class="badge bg-primary me-1">${tag.name}</span>`).join('')}
                                <a href="/Course/${course.id}" class="btn btn-sm btn-outline-primary mt-2">Preview</a>
                            </div>
                        </div>
                    </div>
                `;
                courseContainer.appendChild(courseCard);
            });
        }

        function renderPagination() {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";
            const pageCount = Math.ceil(filteredCourses.length / coursesPerPage);

            for (let i = 1; i <= pageCount; i++) {
                const pageItem = document.createElement("li");
                pageItem.className = `page-item ${i === currentPage ? "active" : ""}`;
                pageItem.innerHTML = `
                    <button class="page-link" onclick="changePage(${i})">${i}</button>
                `;
                pagination.appendChild(pageItem);
            }
        }

        function changePage(page) {
            currentPage = page;
            renderCourses();
            renderPagination();
        }

        function handleFilterChange() {
            filterCourses();
        }

        function handleSearch() {
            filterCourses();
        }

        function filterCourses() {
            const searchQuery = document.getElementById("searchInput").value.toLowerCase();
            const filter = document.getElementById("filterSelect").value;
            const selectedTagId = document.getElementById("tagSelect").value;

            filteredCourses = allCourses.filter(course => {
                const matchesSearch = course.title.toLowerCase().includes(searchQuery) ||
                                    course.description.toLowerCase().includes(searchQuery);
                const matchesFilter = filter === "All" || course.type === filter;
                const matchesTag = selectedTagId === "All" || course.tags.some(tag => tag.id === parseInt(selectedTagId));
                return matchesSearch && matchesFilter && matchesTag;
            });

            currentPage = 1;
            renderCourses();
            renderPagination();
        }

        // Initialize the page
        initializeTags();
        renderCourses();
        renderPagination();
    </script>
}